extends ../head

append css
	link(rel='stylesheet', href='/css/supplemental.css')

append js
	script(src='/js/supplemental.js')

block content
	.container
		.row
			.col-md-9.col-sm-12
				.row
					.col-xs-8.col-sm-9
						h2 #{supplemental.Title}
					.col-xs-4.col-sm-3
						a(href='/proposals/#{proposal.Year}/#{proposal.Number}')
							button.btn.btn-primary.proposalView View Proposal
				p.subtitle by #{supplemental.Author}
				p #{supplemental.Abstract}

			.col-md-3.col-sm-12
				if isAdmin || isCommitteeMember || editor
					if isAdmin || isCommitteeMember
						h3 Voting
						if supplemental.Status == 0
							if vote 
								form
									select(name='voteDecision' disabled).form-control
										option(value='1') Approve
										option(value='0') Deny
									button(disabled)#voteButton.btn Submit
									if vote.Value == 1
										p You have already voted to approve this supplemental
									if vote.Value == 0
										p You have already voted to deny this supplemental
							else 
								form(method='post', action='/api/v1/vote/supplemental/#{supplemental.id}')
									select(name='voteDecision').form-control
										option(value='1') Approve
										option(value='0') Deny
									button#voteButton.btn Submit
						if supplemental.Status == 1
							p This supplemental has been approved.
						if supplemental.Status == 2
							p this supplemental has been denied.
						p #{votesNo} x Deny
						p #{votesYes} x Approve
					hr
					if isAdmin || (editor && supplemental.Status == 0)
						h3 Editor
						p You have edit access to this supplemental.
						a(href='/supplemental/#{supplemental.id}/0') Edit Supplemental
					br

		.row
			if isPartial
				+triColumn()
			else
				+biColumn()


mixin biColumn()
	table.table
		thead
			tr
				th(colspan='2')
				th(colspan='3'): h3 Original
				th(colspan='3'): h3 Supplemental
					
			tr
				th Name
				th
				th Cost
				th Qty
				th Total
				th Cost
				th Qty
				th Total

		- var a
		- var k = 0
		- var totalProp = 0
		- var totalSup = 0
		tbody
			for i, n in itemsProp
				- a = n
				- totalProp += i.Quantity * i.Price
				- j = itemsSup[n]
				- totalSup += j.Quantity * j.Price


				tr
					td #{i.ItemName} 


					td 
						button(id='buttonShow#{k}').btnShow.btn: span.glyphicon.glyphicon-menu-down
						button(id='buttonHide#{k}').btnHide.hidden.btn.btn-danger: span.glyphicon.glyphicon-menu-up
					

					td
						+format(i.Price)


					td #{i.Quantity}


					td
						+format(i.Quantity * i.Price)
		

					if i.ItemName.trim() == j.ItemName.trim() && i.Description.trim() == j.Description.trim() && i.Justification.trim() == j.Justification.trim()
						if j.Price != i.Price
							td: b 
								+format(j.Price)
						else 
							td 
								+format(j.Price)



						if j.Quantity != i.Quantity
							td: b #{j.Quantity}
						else
							td #{j.Quantity}


						if j.Quantity * j.Price != i.Quantity * i.Price
							td: b
								+format(j.Quantity * j.Price)
						else
							td 
								+format(j.Quantity * j.Price)


						tr(id='desc#{k}').hidden
							- k++
							td(colspan='8')= i.Description + i.Justification



					else
						td(colspan='3')
						tr(id='desc#{k}').hidden
							- k++
							td(colspan='8')= i.Description + i.Justification
						tr
							td #{j.ItemName}
							td 
								button(id='buttonShow#{k}').btnShow.btn: span.glyphicon.glyphicon-menu-down
								button(id='buttonHide#{k}').btnHide.hidden.btn.btn-danger: span.glyphicon.glyphicon-menu-up
							td(colspan='3')
							td: b 
								+format(j.Price)
							td: b #{j.Quantity}
							td: b 
								+format(j.Price * j.Quantity)
						tr(id='desc#{k}').hidden
							- k++
							td(colspan='8')= j.Description + j.Justification
			

			- a++
			- for (var n = a; n < itemsSup.length; n++)
				- j = itemsSup[n]
				- totalSup += j.Quantity * j.Price
				tr
					td #{j.ItemName}
					td 
						button(id='buttonShow#{k}').btnShow.btn: span.glyphicon.glyphicon-menu-down
						button(id='buttonHide#{k}').btnHide.hidden.btn.btn-danger: span.glyphicon.glyphicon-menu-up

					td(colspan='3')


					td: b
						+format(j.Price)

					td: b  #{j.Quantity}

					td: b
						+format(j.Price * j.Quantity)

					tr(id='desc#{k}').hidden
						- k++
						td(colspan='8')= j.Description + j.Justification




			tr
				td: b Total 
				td(colspan='3')
				td: b
					+format(totalProp)
				td #{((totalProp > totalSup) ? '-' : '+')} 
					+format(Math.abs(totalProp - totalSup))
				td =
				td: b
					+format(totalSup)






mixin triColumn()
	table.table
		thead
			tr
				th(colspan='2')
				th(colspan='3'): h3 Original
				th(colspan='3'): h3 Funded
				th(colspan='3'): h3 Supplemental
					
			tr
				th Name
				th
				th Cost
				th Qty
				th Total
				th Cost
				th Qty
				th Total
				th Cost
				th Qty
				th Total

		tbody
			- var totalProp = 0
			- var totalPart = 0
			- var totalSup = 0
			- var l = 0 //- row number
			for i, n in itemsProp
				- totalProp += i.Quantity * i.Price
				- j = itemsPart[n]
				- if (j != undefined && j != null)
					- totalPart += j.Quantity * j.Price
				- k = itemsSup[n]
				- if (k != undefined && k != null)
					- totalSup

				//- an item row
				tr 
					td #{i.ItemName}


					td 
						button(id='buttonShow#{l}').btnShow.btn: span.glyphicon.glyphicon-menu-down #{l}a
						button(id='buttonHide#{l}').btnHide.hidden.btn.btn-danger: span.glyphicon.glyphicon-menu-up #{l}a
					

					td
						+format(i.Price)


					td #{i.Quantity}


					td
						+format(i.Quantity * i.Price)
		
					//- if the original and funded are similar
					if j != undefined && j != null && i.ItemName.trim() == j.ItemName.trim() && i.Description.trim() == j.Description.trim() && i.Justification.trim() == j.Justification.trim()
						if j.Price != i.Price
							td: b 
								+format(j.Price)
						else 
							td $#{j.Price}


						if j.Quantity != i.Quantity
							td: b #{j.Quantity}
						else
							td #{j.Quantity}


						if j.Quantity * j.Price != i.Quantity * i.Price
							td: b
								+format(j.Quantity * j.Price)
						else
							td 
								+format(j.Quantity * j.Price)




					else 
						//- an item or desc or just is different from orig to funded
						td 
							+format(i.Price)
						td: b 0
						td: b 
							+format(0)
						td(colspan='3')
						tr(id='desc#{l}').hidden
							- l++
							td(colspan='11')= i.Description + i.Justification
						tr
							td #{j.ItemName}
							td 
								button(id='buttonShow#{l}').btnShow.btn: span.glyphicon.glyphicon-menu-down #{l}b
								button(id='buttonHide#{l}').btnHide.hidden.btn.btn-danger: span.glyphicon.glyphicon-menu-up #{l}b
							td(colspan='3')
							td: b $#{j.Price}
							td: b #{j.Quantity}
							td: b $#{j.Price * j.Quantity}

							if k != null && k != undefined && k.ItemName.trim() == j.ItemName.trim() && k.Description.trim() == j.Description.trim() && k.Justification.trim() == j.Justification.trim()
								if j.Price != k.Price
									td: b 
										+format(k.Quantity * k.Price)
								else 
									td $#{k.Price}


								if j.Quantity != k.Quantity
									td: b #{k.Quantity}
								else
									td #{k.Quantity}


								if j.Quantity * j.Price != k.Quantity * k.Price
									td: b
										+format(k.Quantity * k.Price)
								else
									td 
										+format(k.Quantity * k.Price)
							else
								td(colspan='3')


							tr(id='desc#{l}').hidden
								- l++
								td(colspan='11')= j.Description + j.Justification



					if k != undefined && k != null && j != undefined && j != null
						if k.ItemName.trim() == j.ItemName.trim() && k.Description.trim() == j.Description.trim() && k.Justification.trim() == j.Justification.trim()

							if j.Price != k.Price
								td: b 
									+format(k.Quantity * k.Price)
							else 
								td $#{k.Price}


							if j.Quantity != k.Quantity
								td: b #{k.Quantity}
							else
								td #{k.Quantity}


							if j.Quantity * j.Price != k.Quantity * k.Price
								td: b
									+format(k.Quantity * k.Price)
							else
								td 
									+format(k.Quantity * k.Price)


							tr(id='desc#{l}').hidden
								- l++
								td(colspan='11')= k.Description + k.Justification



						else 
							//- an item or desc or something is different from funded to supp
							td(colspan='9') hurr
							tr(id='desc#{l}').hidden
								- l++
								td(colspan='11')= k.Description + k.Justification
							tr
								td #{k.ItemName}
								td 
									button(id='buttonShow#{l}').btnShow.btn: span.glyphicon.glyphicon-menu-down #{l}c
									button(id='buttonHide#{l}').btnHide.hidden.btn.btn-danger: span.glyphicon.glyphicon-menu-up #{l}c
								td(colspan='3')
								td: b $#{k.Price}
								td: b #{k.Quantity}
								td: b $#{k.Price * k.Quantity}


					else 
						//- we've run out of supplemental items to compare
						- for (var n = a; n < itemsSup.length; n++)
							- k = itemsSup[n]
							tr
								td #{k.ItemName}







			tr
				td: b Total 
				td(colspan='3')
				td: b
					+format(totalProp)
				td #{((totalProp > totalSup) ? '-' : '+')} 
					+format(Math.abs(totalProp - totalSup))
				td =
				td: b
					+format(totalSup)



mixin format(num)
	| #{'$' + (Math.round(num * 100) / 100).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
